# 附近玩家检测系统 - 实施说明

## 实施概述

已完成附近玩家密度检测系统的代码实现，包括：
- ✅ 数据库迁移脚本
- ✅ 数据模型
- ✅ 核心管理器
- ✅ 与现有系统的集成
- ✅ App生命周期处理

## 下一步操作

### 1. 执行数据库迁移

需要在 Supabase Dashboard 中执行数据库迁移脚本。

**步骤：**

1. 登录 Supabase Dashboard: https://supabase.com/dashboard
2. 选择项目：EarthLord (dzfylsyvnskzvpwomcim)
3. 进入 SQL Editor
4. 复制并执行迁移脚本：`supabase/migrations/user_locations.sql`

**迁移脚本包含：**
- 启用 PostGIS 扩展
- 创建 `user_locations` 表（含PostGIS空间索引）
- 创建 RPC 函数：
  - `upsert_user_location` - 位置上报
  - `get_nearby_online_players_count` - 查询附近玩家数量
- 配置 RLS 策略（行级安全）

**验证迁移成功：**
```sql
-- 检查表是否存在
SELECT * FROM user_locations LIMIT 1;

-- 检查函数是否存在
SELECT routine_name FROM information_schema.routines
WHERE routine_schema = 'public'
AND routine_name IN ('upsert_user_location', 'get_nearby_online_players_count');
```

### 2. 构建项目

在执行数据库迁移后，构建iOS项目：

```bash
cd /Users/xinyao/Desktop/EarthLord
xcodebuild -workspace EarthLord.xcworkspace -scheme EarthLord -configuration Debug
```

或在 Xcode 中点击 Build (⌘+B)

**注意事项：**
- 新文件已创建，Xcode可能需要重新索引
- 确认所有新文件已添加到target

### 3. 功能测试

#### 测试1：位置上报
1. 启动App并登录
2. 查看日志，确认启动时立即上报一次位置
3. 等待30秒，确认定时器触发上报
4. 走动超过50米，确认移动触发上报
5. 在Supabase Dashboard查看 `user_locations` 表，验证记录已插入

**预期日志：**
```
[PlayerDensityManager] 位置上报已启动，间隔: 30.0秒
[PlayerDensityManager] 启动时立即上报位置
[PlayerDensityManager] 位置上报成功
- 位置: (纬度, 经度)
- 精度: XX.X米
```

#### 测试2：密度查询与动态POI
1. 点击"开始探索"按钮
2. 查看日志，确认密度查询成功
3. 验证POI数量是否符合密度等级
   - 0人 → 1个POI
   - 1-5人 → 3个POI
   - 6-20人 → 6个POI
   - 20+人 → 20个POI

**预期日志：**
```
[PlayerDensityManager] 密度查询成功
- 附近玩家数量: X人
- 密度等级: 低密度/中密度/高密度
- 建议POI数量: X个

[ExplorationManager] 密度查询完成
- 密度等级: 低密度 (附近1公里内有1-5名玩家)
- POI数量限制: 3个

[POISearchManager] 搜索完成，找到 3 个 POI（限制: 3个）
```

#### 测试3：保底策略
1. 在1公里内无POI的偏远地区开始探索
2. 确认系统自动扩展到2公里搜索
3. 验证日志输出警告信息

**预期日志：**
```
[POISearchManager] 1公里内无POI，扩展到2公里搜索
[POISearchManager] 搜索半径: 2000米
```

#### 测试4：App生命周期
1. App在前台时，查看位置上报是否正常
2. 按Home键进入后台，确认标记为离线
3. 回到前台，确认标记为在线并恢复上报
4. 在Supabase查看 `is_online` 字段变化

**预期日志：**
```
// 进入后台
[PlayerDensityManager] 已标记为离线
[PlayerDensityManager] 位置上报已停止

// 回到前台
[PlayerDensityManager] 已标记为在线
[PlayerDensityManager] 位置上报已启动，间隔: 30.0秒
```

### 4. 手动测试数据库函数

在 Supabase SQL Editor 中测试 RPC 函数：

```sql
-- 测试位置上报
SELECT upsert_user_location(
    'YOUR_USER_ID'::uuid,
    39.915,  -- 纬度
    116.404, -- 经度
    10.0,    -- 精度
    true     -- 在线
);

-- 测试查询附近玩家
SELECT get_nearby_online_players_count(
    'YOUR_USER_ID'::uuid,
    39.915,  -- 查询中心纬度
    116.404, -- 查询中心经度
    1000     -- 半径（米）
);

-- 查看所有在线玩家位置
SELECT
    user_id,
    latitude,
    longitude,
    reported_at,
    is_online,
    NOW() - reported_at AS time_since_report
FROM user_locations
WHERE is_online = true
AND reported_at > NOW() - INTERVAL '5 minutes'
ORDER BY reported_at DESC;
```

### 5. 性能验证

#### 数据库查询性能
```sql
-- 测试空间索引性能
EXPLAIN ANALYZE
SELECT COUNT(*)
FROM user_locations
WHERE is_online = true
AND reported_at > NOW() - INTERVAL '5 minutes'
AND ST_DWithin(
    location,
    ST_SetSRID(ST_MakePoint(116.404, 39.915), 4326)::geography,
    1000
);
```

**预期结果：**
- 查询时间 < 100ms
- 使用 GIST 空间索引（Index Scan）

#### 位置上报频率监控
- 正常情况：30秒一次
- 移动触发：距离 ≥ 50米
- 确认没有频繁无效上报（GPS抖动）

## 边界情况处理

### 网络异常
- ✅ 位置上报失败：静默失败，下次重试
- ✅ 密度查询失败：返回低密度（3个POI）
- ✅ POI搜索失败：不影响探索功能

### 无POI区域
- ✅ 1公里内无POI → 自动扩展到2公里
- ✅ 2公里内仍无POI → 返回空数组（不崩溃）

### GPS不可用
- ✅ 关闭定位权限 → 不尝试上报位置
- ✅ 位置精度低 → 仍然上报（记录精度值）

## 已实现的文件清单

### 新建文件
1. ✅ `supabase/migrations/user_locations.sql` - 数据库迁移脚本
2. ✅ `EarthLord/Models/PlayerDensityModels.swift` - 密度数据模型
3. ✅ `EarthLord/Managers/PlayerDensityManager.swift` - 核心管理器

### 修改文件
1. ✅ `EarthLord/Managers/LocationManager.swift:615` - 集成位置上报触发
2. ✅ `EarthLord/Managers/ExplorationManager.swift:236-263,608` - 集成密度查询
3. ✅ `EarthLord/Managers/POISearchManager.swift:62` - 支持动态POI数量
4. ✅ `EarthLord/Views/RootView.swift:13-61` - App生命周期处理

## 系统架构

```
用户位置更新
    ↓
LocationManager.didUpdateLocations (每次GPS更新)
    ↓
PlayerDensityManager.checkAndReportIfNeeded (移动50米触发)
    ↓
Supabase RPC: upsert_user_location
    ↓
user_locations表更新

═══════════════════════════════════

用户点击"开始探索"
    ↓
ExplorationManager.startExploration()
    ↓
PlayerDensityManager.queryNearbyPlayerDensity()
    ↓
Supabase RPC: get_nearby_online_players_count
    ↓
计算密度等级 (solo/low/medium/high)
    ↓
POISearchManager.searchNearbyPOIs(limit: X)
    ↓
MapKit搜索 → 返回动态数量的POI
    ↓
LocationManager.startMonitoringPOIs()
    ↓
探索开始
```

## 定时任务

1. **位置上报定时器** (30秒)
   - 启动时机：App前台 + 已登录
   - 停止时机：进入后台 / 退出登录

2. **移动触发上报** (50米)
   - 每次GPS更新时检查距离
   - 超过50米立即上报

## 数据库数据示例

### user_locations 表
```
id: 123e4567-e89b-12d3-a456-426614174000
user_id: 456e7890-e89b-12d3-a456-426614174001
location: SRID=4326;POINT(116.404 39.915)
latitude: 39.915
longitude: 116.404
accuracy: 10.5
reported_at: 2026-01-14 10:30:00+00
is_online: true
created_at: 2026-01-14 10:00:00+00
updated_at: 2026-01-14 10:30:00+00
```

## 隐私保护措施

1. ✅ 只返回数量，不返回具体位置
2. ✅ RLS策略：用户只能查看自己的位置
3. ✅ SECURITY DEFINER函数：绕过RLS但只返回聚合数据
4. ✅ 不暴露用户ID和身份信息

## 故障排查

### 问题1：位置上报失败
**可能原因：**
- 用户未登录
- 网络连接问题
- Supabase函数未部署

**解决方案：**
- 检查认证状态
- 检查网络连接
- 验证Supabase迁移是否成功

### 问题2：密度查询返回0
**可能原因：**
- 附近确实没有其他玩家
- 其他玩家超过5分钟未上报
- 数据库查询问题

**解决方案：**
- 正常情况，系统会显示1个POI（独行者模式）
- 检查 `user_locations` 表是否有数据

### 问题3：POI数量不符合预期
**可能原因：**
- 密度查询失败，使用默认值
- 附近真实POI数量不足

**解决方案：**
- 检查密度查询日志
- 在不同地区测试
- 验证保底策略是否生效（2公里搜索）

## 后续优化建议

1. **性能优化**
   - 添加位置上报缓存（离线时缓存，联网后批量上传）
   - 优化数据库查询（增加索引）

2. **功能增强**
   - 添加"隐身模式"（不被其他玩家统计）
   - 支持自定义查询半径
   - 显示历史密度变化趋势

3. **用户体验**
   - UI显示附近玩家数量（可选）
   - 密度变化时的动画提示
   - 探索历史记录中记录密度信息

## 参考文档

- 设计文档：`/Users/xinyao/Downloads/附近玩家检测方案.md`
- 实施计划：`/Users/xinyao/.claude/plans/giggly-soaring-gizmo.md`
- Supabase Dashboard: https://supabase.com/dashboard/project/dzfylsyvnskzvpwomcim

## 完成状态

✅ 所有代码实现完成
⏳ 等待数据库迁移执行
⏳ 等待功能测试验证

---

*实施日期: 2026-01-14*
*开发者: Claude Sonnet 4.5*
